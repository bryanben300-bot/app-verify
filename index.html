<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Redirect Generator</title>
<style>
html,body {height:100%; margin:0; padding:0; font-family:Arial,sans-serif; background:#f8f9fa; color:#111;}
.section {border:1px solid #e0e0e0; padding:14px; border-radius:8px; margin:18px auto; max-width:960px; background:#fff;}
input[type="text"] {width:72%; padding:8px; border:1px solid #ccc; border-radius:4px;}
button {padding:8px 12px; border-radius:6px; border:0; background:#0366d6; color:#fff; cursor:pointer;}
.sample {word-break:break-all; color:#0366d6; text-decoration:none;}
#verify-screen {display:none; align-items:center; justify-content:center; height:100vh; background:#f8f9fa;}
#verify-box {background:#fff; padding:30px; border-radius:10px; box-shadow:0 4px 16px rgba(0,0,0,0.1); text-align:center;}
h2 {font-weight:500; margin-bottom:14px;}
</style>

<!-- Cloudflare Turnstile -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script>
// ----------------------- CONFIG -----------------------
const CONFIG = {
    PUBLIC_HOST: window.location.origin + window.location.pathname,
    API_ENDPOINT: '/get-url' // Your server endpoint that knows the secret key
};

// ----------------------- Random page titles -----------------------
const pageTitles = ["Explore New Horizons","Hidden Journey","Mystery Path","Secret Portal","Adventure Awaits","The Unknown","Secret Passage","Lost Trail","Enchanted Gateway","Whispering Woods"];
document.title = pageTitles[Math.floor(Math.random()*pageTitles.length)];

// ----------------------- DOM events -----------------------
window.addEventListener('DOMContentLoaded', async ()=>{
    const params = new URLSearchParams(location.search);
    const w = params.get('w');
    if(!w){ 
        document.getElementById('generator').style.display='block'; 
        return; 
    }

    // Show verify screen
    document.getElementById('verify-screen').style.display='flex';
    const btn = document.getElementById('continueBtn'); 
    let verified=false;

    window.onTurnstileSuccess = function(token){ 
        verified=true; 
        btn.disabled=false; 
        btn.textContent='Continue'; 
    };

    btn.addEventListener('click', async ()=>{
        if(!verified){ alert('Please complete the verification first.'); return; }
        btn.disabled=true; 
        btn.textContent='Redirecting...';

        try{
            const res = await fetch(`${CONFIG.API_ENDPOINT}?id=${encodeURIComponent(w)}`);
            if(!res.ok) throw new Error('Invalid link or server error');
            const data = await res.json();
            if(!data.url) throw new Error('No URL returned');
            window.location.href = data.url;
        } catch(e){
            document.body.innerHTML='<p style="text-align:center;color:red;">Invalid or malformed link.</p>';
        }
    });
});

// ----------------------- Link generator -----------------------
async function generateLink(){
    const dest = document.getElementById('targetInput').value.trim();
    if(!dest) return alert('Enter a destination URL.');

    // Generate a random ID
    const randomId = crypto.randomUUID ? crypto.randomUUID() : 'id-'+Math.random().toString(36).slice(2,12);

    // Send to server to store mapping
    await fetch('/store-url', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({id: randomId, url: dest})
    });

    const final = `${CONFIG.PUBLIC_HOST}?w=${randomId}`;
    document.getElementById('generated').innerHTML = `<div><strong>Encoded link:</strong><br/><a class="sample" href="${final}" target="_blank">${final}</a></div>`;
}
</script>
</head>

<body>

<!-- Generator section -->
<div id="generator" class="section" style="display:none;">
<h2>Generate a redirect link</h2>
<input id="targetInput" type="text" placeholder="Enter destination URL (e.g. https://example.com)" />
<button onclick="generateLink()">Generate</button>
<div id="generated" style="margin-top:12px;"></div>
<div style="margin-top:10px;color:#666;font-size:13px;">All generated links will start with:<br/><code style="word-break:break-all;">${window.location.origin}${window.location.pathname}</code></div>
</div>

<!-- Verify screen -->
<div id="verify-screen">
<div id="verify-box">
<h2>Verify to Continue</h2>
<div class="cf-turnstile" data-sitekey="0x4AAAAAAB_GRO5x_mAh22NL" data-callback="onTurnstileSuccess"></div>
<button id="continueBtn" disabled>Waiting for verification...</button>
</div>
</div>

</body>
</html>
